# =============================================================================
# Flare Analysis Configuration
# =============================================================================
# Unified config for FOXES flare detection, tracking, and HEK catalog matching
#
# Usage: python flare_analysis.py --config flare_analysis_config.yaml
# =============================================================================

# -----------------------------------------------------------------------------
# Data Paths
# -----------------------------------------------------------------------------
paths:
  data_dir: "/data/FOXES_Data"
  flux_path: "/data/FOXES_Data/batch_results/vit/flux"
  aia_path: "/data/FOXES_Data/AIA"
  predictions_csv: "/data/FOXES_Data/batch_results/vit/vit_predictions_all.csv"
  hek_catalog: '/data/FOXES_Data/hek_catalog_2023-07-01_2023-07-31.csv' # null to auto-fetch
  output_dir: "/data/FOXES_Data"

# -----------------------------------------------------------------------------
# Time Range
# -----------------------------------------------------------------------------
time_range:
  start: "2023-07-01T00:00:00"
  end: "2023-07-02T23:59:59"
  auto_fetch_hek: true

# -----------------------------------------------------------------------------
# Detection Parameters
# -----------------------------------------------------------------------------
detection:
  # Minimum GOES class for catalog (filters weak events)
  min_goes_class: "B1.0"
  
  # Flux threshold for region detection
  min_flux_threshold: 0.0000001  # 1e-7
  
  # Peak clustering parameters
  threshold_std_multiplier: 5.0   # Higher = fewer false positives
  peak_neighborhood_size: 20      # Local max window size (patches)
  peak_assignment_max_distance: 5 # Max patch-to-peak distance
  flux_decrease_strictness: 0.5   # Flux monotonicity requirement (0-1)
  
  # HEK matching
  hek_match_window_minutes: 5.0

# -----------------------------------------------------------------------------
# Peak Detection (within tracks)
# -----------------------------------------------------------------------------
# Controls how flare peaks are identified within tracked regions
peak_detection:
  height_multiplier: 1      # Peak must be this multiple of baseline
  baseline_window: 60        # Rolling window size for adaptive baseline (number of points)
  min_peak_separation_minutes: 15 # Minimum time between peaks
  validation_window: 6       # Number of points to check on each side of peak for validation
  validation_min_lower: 2    # Minimum number of lower points required on each side
  
  # DBSCAN-based region clustering (optional alternative to peak-based assignment)
  use_dbscan_regions: false  # Use DBSCAN for region clustering instead of peak assignment
  dbscan_eps: 3.0  # DBSCAN epsilon parameter (distance threshold)
  dbscan_min_samples: 3  # DBSCAN minimum samples per cluster
  dbscan_use_peaks: true  # Use find_flux_peaks to guide DBSCAN clustering
  dbscan_peak_weight: .5  # Weight for peak proximity feature (0 = ignore peaks)

# -----------------------------------------------------------------------------
# Region Tracking
# -----------------------------------------------------------------------------
tracking:
  max_tracking_distance: 25       # Max pixel distance between frames
  max_time_gap_minutes: 120.0     # Max gap to bridge (2 hours)
  flare_distance_relax_factor: 4.5  # Distance multiplier for flaring regions
  flux_smoothing_window: 1        # Temporal smoothing window

# -----------------------------------------------------------------------------
# Event Quality Filters
# -----------------------------------------------------------------------------
quality:
  cadence_seconds: 60.0           # Expected data cadence
  max_gap_minutes: 30.0           # Max gap within a sequence
  min_duration_minutes: 5.0       # Minimum event duration
  min_samples: 6                  # Minimum frames in event

# -----------------------------------------------------------------------------
# Grid / Patch Parameters
# -----------------------------------------------------------------------------
grid:
  grid_size: [64, 64]
  patch_size: 8
  input_size: 512

# -----------------------------------------------------------------------------
# HEK-Only Event Filtering
# -----------------------------------------------------------------------------
# Controls which HEK events (not matched to FOXES) are reported/plotted
# Only events with adequate FOXES data coverage are included
hek_coverage:
  coverage_window_minutes: 30.0   # Time window (Â±minutes) around HEK peak
  max_gap_minutes: 10.0           # Max gap to nearest FOXES data point
  min_points_around_peak: 3       # Min points required BEFORE and AFTER peak

# -----------------------------------------------------------------------------
# Simultaneous Flare Detection
# -----------------------------------------------------------------------------
simultaneous_detection:
  enabled: true  # Enable detection of simultaneous flares
  threshold: 5e-6  # Flux threshold for simultaneous flare detection
  sequence_window_hours: 1.0  # Time window for detecting flare sequences

# -----------------------------------------------------------------------------
# Output Options
# -----------------------------------------------------------------------------
output:
  create_plots: false
  plot_window_hours: 2.0

# -----------------------------------------------------------------------------
# Movie Generation
# -----------------------------------------------------------------------------
movie:
  create_movie: true  # Create movie visualization
  fps: 30.0  # Frames per second for movie
  frame_interval_minutes: 2.5  # Time between frames (minutes)
  num_workers: 32  # Number of parallel workers for frame generation
