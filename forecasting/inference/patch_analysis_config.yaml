# Patch Analysis Configuration
# Configuration for flux contribution analysis and flare detection

# Data paths
base_data_dir: "/mnt/data/batch_results/new_weights_local"
flux_path: "${base_data_dir}/flux"
aia_path: "/mnt/data/PAPER_DATA_WITH_335/AIA"
output_path: "${base_data_dir}/new_weights_local_predictions.csv"

# Grid and patch parameters
grid_size: [64, 64]
patch_size: 8
input_size: 512

# Analysis parameters
analysis:
  # Time period for analysis
  time_period:
    start_time: "2023-01-01T00:00:00"
    end_time: "2025-09-26T00:00:00"
  
  # Flare detection parameters
  # Thresholds: median + (std_multiplier * standard_deviation) - calculated in log space
  flare_detection:
    # Threshold multipliers (in log space - more appropriate for flux data)
    threshold_std_multiplier: 1
    core_threshold_std_multiplier: 2.0      # Higher threshold for stable cores
    growth_threshold_std_multiplier: 1.5   # Lower threshold for region growth
    
    # Size constraints
    min_core_patches: 6                    # Minimum core size for stability
    min_patches: 12                        # Minimum total region size
    max_patches: 300                       # Maximum region size
    
    # Morphological operations
    closing_iterations: 5                  # More closing to fill gaps and reduce flickering
    dilation_iterations: 1                 # Dilation for region growth
    prevent_overlap: true                  # Prevent overlapping regions
    
    # Temporal smoothing (applied to detected region flux values and sizes)
    flux_smoothing_window: 3               # Window size for flux value and size smoothing
    
    # Hysteresis (appear/disappear thresholds to reduce flickering)
    use_hysteresis: true                   # Enable hysteresis for stable region tracking
    appear_threshold_std_multiplier: 2.0    # Higher threshold - regions must exceed this to appear (defaults to core_threshold if not set)
    disappear_threshold_std_multiplier: 1.2 # Lower threshold - regions disappear below this (defaults to growth_threshold if not set)
    hysteresis_max_gap_frames: 10           # Maximum frames a region can be missing before disappearing
    
    # Simultaneous flare detection
    simultaneous_flare_threshold: 0.000001
    sequence_window_hours: 1.0  # Time window for clustering groups into flare sequences
  
  # Output configuration
  output:
    output_dir: "${base_data_dir}/patch_analysis_output"
    
    # Movie generation
    create_contour_movie: true
    create_simultaneous_flare_movies: true
    simultaneous_flare_window_days: .25
    movie_fps: 15
    movie_interval_seconds: 12
    show_sxr_timeseries: true
    max_tracking_distance: 75  # Increased for better tracking across frames
