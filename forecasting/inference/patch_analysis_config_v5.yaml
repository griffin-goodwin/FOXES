# Patch Analysis Configuration (Version 5 - Simplified DBSCAN)
# Configuration for flux contribution analysis and flare detection
# 
# Version 5 features:
# - Simplified DBSCAN detection: Simple, intuitive clustering on flux maps
#   Filters patches by threshold, then clusters by spatial position + flux value
#   Easy to tune and understand - mimics how humans identify regions visually
# - DBSCAN track merging: Merges fragmented tracks that belong to the same
#   physical region, improving tracking robustness across temporal gaps
# - Uses median + standard deviation thresholding (same as v1) for automatic threshold
#   determination, calculated in log space for better distribution with flux data

# Data paths
base_data_dir: "/data/FOXES_Data/batch_results/vit/"
flux_path: "${base_data_dir}/flux"
aia_path: "/data/FOXES_Data/AIA"
output_path: "${base_data_dir}/vit_predictions.csv"

# Grid and patch parameters
grid_size: [64, 64]
patch_size: 8
input_size: 512

# Analysis parameters
analysis:
  # Time period for analysis
  time_period:
    start_time: "2024-03-20T00:00:00"
    end_time: "2024-03-27T00:00:00"
  
  # Flare detection parameters
  # Thresholds: median + (std_multiplier * standard_deviation) - calculated in log space
  flare_detection:
    # Detection method selection
    use_dbscan_for_detection: true         # Use DBSCAN clustering for region detection (alternative to threshold-based)
    
    # Threshold multipliers (in log space - more appropriate for flux data) - used when use_dbscan_for_detection is false
    threshold_std_multiplier: 1
    core_threshold_std_multiplier: 2.0      # Higher threshold for stable cores
    growth_threshold_std_multiplier: 1.0   # Lower threshold for region growth
    
    # DBSCAN detection parameters (used when use_dbscan_for_detection is true)
    # Simplified approach: filter by threshold, then cluster by spatial position + flux value
    dbscan_detection_eps: 2               # Maximum distance (patches) between patches to be in same cluster
    dbscan_detection_min_samples: 3         # Minimum number of patches required to form a region
    dbscan_detection_threshold_std_multiplier: 1.0  # Threshold multiplier for filtering patches (median + std, same as v1)
    dbscan_detection_use_flux: false         # Include flux in clustering features (false = spatial only)
                                         # When true: clusters patches that are close in space AND have similar flux values
                                         # Simple and intuitive - mimics how humans identify regions visually
    dbscan_detection_use_gradient: false     # Include flux gradient in clustering features (alternative to flux value)
                                         # When true: clusters patches with similar flux gradients (spatial change)
                                         # Useful for identifying region boundaries and edges
    dbscan_detection_flux_weight: 0.2       # Weight for log flux dimension when use_flux is true (0-1)
                                         # Lower = more emphasis on spatial proximity, higher = more on flux similarity
                                         # Recommended: 0.2-0.4 for balanced clustering
    dbscan_detection_gradient_weight: 0.3    # Weight for log gradient dimension when use_gradient is true (0-1)
                                         # Lower = more emphasis on spatial proximity, higher = more on gradient similarity
                                         # Recommended: 0.2-0.4 for balanced clustering
    dbscan_detection_use_previous_regions: false  # Include previous region proximity in clustering features
                                         # When true: patches closer to previous region locations are more likely to cluster together
                                         # This helps maintain region identity when regions are close or merging
                                         # Note: Enables sequential detection (slower but more accurate)
    dbscan_detection_previous_region_weight: 0.3  # Weight for previous region proximity dimension (0-1)
                                         # Lower = less influence from previous regions, higher = stronger temporal continuity
                                         # Recommended: 0.2-0.5 depending on how stable regions should be
    
    # Region tracking parameters
    # Tracking is based on spatial proximity only


    # Size constraints
    # Note: min_patches, max_patches, min_core_patches only used when use_dbscan_for_detection is false
    # When DBSCAN detection is enabled, DBSCAN handles clustering automatically via min_samples parameter
    min_core_patches: 12                     # Minimum core size for stability (traditional thresholding only)
    min_patches: 15                          # Minimum total region size (traditional thresholding only, set to 0 to disable)
    max_patches: 300                         # Maximum region size (traditional thresholding only, set to 0 to disable)
    min_flux_threshold: 0.0000001            # Minimum sum flux for a region to be accepted (set to null to disable)
    
    # Morphological operations
    closing_iterations: 1                   # More closing to fill gaps and reduce flickering
    dilation_iterations: 1                 # Dilation for region growth
    prevent_overlap: true                   # Prevent overlapping regions
    core_merge_distance: 0                 # Distance (patches) to merge close/overlapping cores (0 = disabled)
    
    # Temporal smoothing (applied to detected region flux values and sizes)
    flux_smoothing_window: 1                # Window size for flux value and size smoothing
    
    # DBSCAN clustering for track merging (Version 3 feature)
    use_dbscan_clustering: true             # Enable DBSCAN clustering to merge fragmented tracks
    dbscan_eps: 100.0                       # Maximum distance (pixels) between tracks to be in same cluster
    dbscan_min_samples: 2                   # Minimum number of tracks required to form a cluster
    dbscan_time_scale: 1.0                  # Time scaling factor (pixels per second) for temporal features
    dbscan_flux_scale: 0.0                  # Flux scaling factor (0 = don't use flux in clustering)
    
    # Region size change constraints (for tracked regions in sequences)
    # Note: Only used during tracking, not during initial detection
    max_size_growth_factor: 0                # Maximum allowed size ratio between frames (set to 0 or null to disable)
    max_size_shrinkage_factor: 0             # Minimum allowed size ratio between frames (set to 0 or null to disable)
    
    # Simultaneous flare detection
    simultaneous_flare_threshold: 0.000005
    sequence_window_hours: 1.0               # Time window for clustering groups into flare sequences
  
  # Output configuration
  output:
    output_dir: "${base_data_dir}/patch_analysis_output_v5"
    
    # Movie generation
    create_contour_movie: false
    create_simultaneous_flare_movies: true
    create_contour_movies_for_sequences: true  # Create contour movies for simultaneous flare sequences
    create_flux_heatmap_movies_for_sequences: true  # Create flux heatmap movies for simultaneous flare sequences
    simultaneous_flare_window_days: .25
    movie_fps: 15
    movie_interval_seconds: 12
    show_sxr_timeseries: true
    max_tracking_distance: 75               # Increased for better tracking across frames

